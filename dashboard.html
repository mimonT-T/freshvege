<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreshVege Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #82C09A 0%, #6FB377 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4fa363 0%, #65b69e 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="30" cy="15" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="5" r="2.5" fill="rgba(255,255,255,0.1)"/><circle cx="70" cy="12" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="8" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .dashboard-nav {
            background: #f8f9fa;
            padding: 25px 40px;
            border-bottom: 2px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,123,255,0.2);
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,123,255,0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }

        .content {
            padding: 40px;
            min-height: 600px;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #e9ecef;
        }

        .section-header h2 {
            font-size: 2.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .section-header p {
            color: #666;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .form-control, select.form-control {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus, select.form-control:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 4px rgba(40,167,69,0.1);
            transform: translateY(-1px);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2a6906 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 18px 35px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40,167,69,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40,167,69,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #28a745;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            color: #666;
            font-weight: 500;
        }

        .products-grid, .farmers-grid, .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #28a745, #20c997);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .card:hover::before {
            transform: scaleY(1);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #28a745;
        }

        .card-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .card-details {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .card-price {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }

        .order-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #28a745;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f8f9fa;
        }

        .order-number {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .status-processing { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status-shipped { background: #cce5ff; color: #004085; border: 2px solid #b3d7ff; }
        .status-delivered { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status-cancelled { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }

        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .info-value {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-weight: 500;
            border-left: 5px solid;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .search-filter {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .products-grid, .farmers-grid, .customers-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .nav-buttons {
                justify-content: center;
            }
            
            .customer-info {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FreshVege Dashboard</h1>
            <p>Farm to Doorstep Management System</p>
        </div>

        <div class="dashboard-nav">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('overview')"> Overview</button>
                <button class="nav-btn" onclick="showSection('add-product')"> Add Product</button>
                <button class="nav-btn" onclick="showSection('view-products')"> Products</button>
                <button class="nav-btn" onclick="showSection('manage-farmers')"> Farmers</button>
                <button class="nav-btn" onclick="showSection('manage-customers')"> Customers</button>
                <button class="nav-btn" onclick="showSection('view-orders')"> Orders</button>
            </div>
        </div>

        <div class="content">
            <!-- Overview Section -->
            <div id="overview" class="section active">
                <div class="section-header">
                    <h2>Dashboard Overview</h2>
                    <p>Welcome to FreshVege management system - connecting Bangladeshi farmers with customers</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-products">24</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-farmers">6</div>
                        <div class="stat-label">Active Farmers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-customers">5</div>
                        <div class="stat-label">Registered Customers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-orders">5</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                </div>

                <div class="search-filter">
                    <h3 style="margin-bottom: 20px; color: #333;">Quick Actions</h3>
                    <div class="filter-row">
                        <button class="btn-primary" onclick="showSection('add-product')">Add New Product</button>
                        <button class="btn-primary" onclick="showSection('manage-farmers')">Register Farmer</button>
                        <button class="btn-primary" onclick="showSection('view-orders')">Check Orders</button>
                        <button class="btn-primary" onclick="loadAllData()">Refresh Data</button>
                    </div>
                </div>
            </div>

            <!-- Add Product Section -->
            <div id="add-product" class="section">
                <div class="section-header">
                    <h2>Add New Product</h2>
                    <p>Register fresh produce from our farmers</p>
                </div>
                
                <form id="productForm" method="POST">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="farmer_id">Select Farmer</label>
                            <select class="form-control" id="farmer_id" name="farmer_id" required>
                                <option value="">Choose a farmer...</option>
                                <option value="1">Rahim Hasnat (Chattogram)</option>
                                <option value="2">Abrar Sayed Tasin (Dhaka)</option>
                                <option value="3">Kuddus Ali (Rajshahi)</option>
                                <option value="4">Fatema Begum (Dhaka)</option>
                                <option value="5">Abdul Karim (Cumilla)</option>
                                <option value="6">Nasir Uddin (Dinajpur)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="category_id">Category</label>
                            <select class="form-control" id="category_id" name="category_id" required>
                                <option value="">Choose a category...</option>
                                <option value="1">Vegetables</option>
                                <option value="2">Fruits</option>
                                <option value="3">Grains</option>
                                <option value="4">Pulses</option>
                                <option value="5">Spices</option>
                                <option value="6">Herbs</option>
                                <option value="7">Dried</option>
                                <option value="8">Juices</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="name">Product Name (English & বাংলা)</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="e.g., Fresh Tomatoes - টাটকা টমেটো" required>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4" placeholder="Describe the product quality, origin, and benefits in Bengali/English"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="price">Price (৳ Taka)</label>
                            <input type="number" step="0.01" class="form-control" id="price" name="price" placeholder="75.00" required>
                        </div>
                        <div class="form-group">
                            <label for="quantity_available">Quantity Available</label>
                            <input type="number" step="0.01" class="form-control" id="quantity_available" name="quantity_available" placeholder="25.50" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="unit_id">Unit</label>
                            <select class="form-control" id="unit_id" name="unit_id" required>
                                <option value="">Choose a unit...</option>
                                <option value="1">Kilogram (kg)</option>
                                <option value="2">Gram (g)</option>
                                <option value="3">Piece (pcs)</option>
                                <option value="4">Dozen (dz)</option>
                                <option value="5">Liter (l)</option>
                                <option value="6">Bundle (মুঠা)</option>
                                <option value="7">Bag (বস্তা)</option>
                                <option value="8">Maund (মণ)</option>
                                <option value="9">Seer (সের)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="image_url">Image URL (optional)</label>
                            <input type="url" class="form-control" id="image_url" name="image_url" placeholder="images/product-name.jpg">
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">Add Product to Inventory</button>
                </form>
            </div>

            <!-- View Products Section -->
            <div id="view-products" class="section">
                <div class="section-header">
                    <h2>Product Inventory</h2>
                    <p>Current products from our farmer network</p>
                </div>
                
                <div class="search-filter">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Filter by Category</label>
                            <select class="form-control" id="product-category-filter">
                                <option value="">All Categories</option>
                                <option value="1">Vegetables</option>
                                <option value="2">Fruits</option>
                                <option value="3">Grains</option>
                                <option value="4">Pulses</option>
                                <option value="5">Spices</option>
                                <option value="8">Juices</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Search Products</label>
                            <input type="text" class="form-control" id="product-search" placeholder="Search by name...">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn-primary" onclick="loadProducts()">Search Products</button>
                        </div>
                    </div>
                </div>
                
                <div id="products-container" class="products-grid">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- Manage Farmers Section -->
            <div id="manage-farmers" class="section">
                <div class="section-header">
                    <h2>Farmer Management</h2>
                    <p>Register and manage our farming partners</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 25px; color: #333;">Add New Farmer</h3>
                    <form id="farmerForm" method="POST">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="farmer_name">Farmer Name</label>
                                <input type="text" class="form-control" id="farmer_name" name="farmer_name" placeholder="রহিম হাসনাত" required>
                            </div>
                            <div class="form-group">
                                <label for="farmer_email">Email (optional)</label>
                                <input type="email" class="form-control" id="farmer_email" name="farmer_email" placeholder="farmer@gmail.com">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="farmer_phone">Phone Number</label>
                                <input type="tel" class="form-control" id="farmer_phone" name="farmer_phone" placeholder="01712345678">
                            </div>
                            <div class="form-group">
                                <label for="farmer_city">City/District</label>
                                <input type="text" class="form-control" id="farmer_city" name="farmer_city" placeholder="Chattogram">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="farmer_address">Full Address</label>
                            <textarea class="form-control" id="farmer_address" name="farmer_address" rows="3" placeholder="Village/Farm location with full address"></textarea>
                        </div>

                        <button type="submit" class="btn-primary">Register Farmer</button>
                    </form>
                </div>

                <h3 style="margin-bottom: 25px; color: #333;">Current Farmers</h3>
                <div id="farmers-container" class="farmers-grid">
                    <!-- Farmers will be loaded here -->
                </div>
            </div>

            <!-- Manage Customers Section -->
            <div id="manage-customers" class="section">
                <div class="section-header">
                    <h2>Customer Management</h2>
                    <p>Manage customer accounts and information</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 25px; color: #333;">Add New Customer</h3>
                    <form id="customerForm" method="POST">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customer_first_name">First Name</label>
                                <input type="text" class="form-control" id="customer_first_name" name="customer_first_name" placeholder="রাইয়ান" required>
                            </div>
                            <div class="form-group">
                                <label for="customer_last_name">Last Name</label>
                                <input type="text" class="form-control" id="customer_last_name" name="customer_last_name" placeholder="রহমান" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="customer_email">Email Address</label>
                                <input type="email" class="form-control" id="customer_email" name="customer_email" placeholder="customer@gmail.com" required>
                            </div>
                            <div class="form-group">
                                <label for="customer_phone">Phone Number</label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone" placeholder="01712223334">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="customer_city">City</label>
                                <input type="text" class="form-control" id="customer_city" name="customer_city" placeholder="Dhaka">
                            </div>
                            <div class="form-group">
                                <label for="customer_state">Division</label>
                                <input type="text" class="form-control" id="customer_state" name="customer_state" placeholder="Dhaka Division">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="customer_address">Address</label>
                            <textarea class="form-control" id="customer_address" name="customer_address" rows="3" placeholder="House 42, Road 15, Dhanmondi"></textarea>
                        </div>

                        <button type="submit" class="btn-primary">Add Customer</button>
                    </form>
                </div>

                <h3 style="margin-bottom: 25px; color: #333;">Customer Directory</h3>
                <div id="customers-container" class="customers-grid">
                    <!-- Customers will be loaded here -->
                </div>
            </div>

            <!-- View Orders Section -->
            <div id="view-orders" class="section">
                <div class="section-header">
                    <h2>Order Management</h2>
                    <p>Track and manage customer orders</p>
                </div>
                
                <div class="search-filter">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Filter by Status</label>
                            <select class="form-control" id="order-status-filter">
                                <option value="">All Orders</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Search Orders</label>
                            <input type="text" class="form-control" id="order-search" placeholder="Search by order number or customer...">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn-primary" onclick="loadOrders()">Refresh Orders</button>
                        </div>
                    </div>
                </div>
                
                <div id="orders-container">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
// Global variables to store data
let allProducts = [];
let allFarmers = [];
let allCustomers = [];
let allOrders = [];
let categories = [];
let units = [];

// API base URL - adjust this to match your server setup
// Try different possible paths:
const API_BASE_URL = getApiUrl();

function getApiUrl() {
    // Try to detect the correct API path
    const currentPath = window.location.pathname;
    const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
    
    // Common API paths to try
    const possiblePaths = [
        'api.php',                    // Same directory
        './api.php',                  // Same directory (explicit)
        '../api.php',                 // Parent directory
        '/api.php',                   // Root directory
        currentDir + '/api.php',      // Current directory
        'backend/api.php',            // Backend folder
        'api/index.php',              // API folder
        'includes/api.php'            // Includes folder
    ];
    
    // For now, return the most common path
    // You can modify this based on your actual file structure
    return 'api.php';
}

// Utility function to make API calls
async function apiCall(action, method = 'GET', data = null) {
    try {
        // Test API availability first
        if (!window.apiTested) {
            await testApiConnection();
            window.apiTested = true;
        }
        
        const options = {
            method: method,
            headers: {
                'Content-Type': method === 'POST' ? 'application/x-www-form-urlencoded' : 'application/json'
            }
        };
        
        let url = `${API_BASE_URL}?action=${action}`;
        
        if (method === 'POST' && data) {
            const formData = new URLSearchParams();
            Object.keys(data).forEach(key => {
                if (data[key] !== null && data[key] !== undefined) {
                    formData.append(key, data[key]);
                }
            });
            options.body = formData;
        }
        
        console.log(`Making API call: ${method} ${url}`);
        const response = await fetch(url, options);
        
        if (!response.ok) {
            // Get the actual error content
            const errorText = await response.text();
            console.error('Server error response:', errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText.substring(0, 200)}...`);
        }
        
        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('Non-JSON response received:', textResponse);
            
            // If it's a PHP error, show it
            if (textResponse.includes('Parse error') || textResponse.includes('Fatal error')) {
                throw new Error(`PHP Error: ${textResponse.substring(0, 300)}`);
            }
            
            throw new Error(`Server returned ${contentType} instead of JSON. Response: ${textResponse.substring(0, 200)}`);
        }
        
        const result = await response.json();
        console.log(`API response for ${action}:`, result);
        return result;
    } catch (error) {
        console.error('API call failed:', error);
        
        // Provide specific error messages
        if (error.message.includes('404')) {
            showAlert(`API file not found. Please check that api.php exists in your server directory.`, 'error');
        } else if (error.message.includes('Failed to fetch')) {
            showAlert(`Cannot connect to server. Please check if your web server is running.`, 'error');
        } else if (error.message.includes('PHP Error')) {
            showAlert(`PHP Error in api.php: ${error.message}`, 'error');
        } else if (error.message.includes('Unexpected token')) {
            showAlert(`Server returned HTML instead of JSON. This usually means there's a PHP error. Check browser console for details.`, 'error');
        } else if (error.message.includes('application/x-httpd-php')) {
            showAlert(`
                <strong>PHP Not Running!</strong><br>
                Your web server is not executing PHP files. Please:<br>
                • If using XAMPP: Start Apache with PHP module<br>
                • If using WAMP: Make sure Apache and PHP are running<br>
                • If using VS Code Live Server: Switch to XAMPP/WAMP/MAMP<br>
                • Access via http://localhost/your-project/ (not file://)
            `, 'error');
        } else {
            showAlert(`API Error: ${error.message}`, 'error');
        }
        
        return { success: false, error: error.message };
    }
}

// Test API connection
async function testApiConnection() {
    try {
        console.log(`Testing API connection at: ${API_BASE_URL}`);
        const response = await fetch(`${API_BASE_URL}?action=get_stats`);
        if (!response.ok) {
            throw new Error(`API test failed: ${response.status} ${response.statusText}`);
        }
        console.log('API connection successful');
        return true;
    } catch (error) {
        console.error('API connection test failed:', error);
        
        // Show detailed troubleshooting message
        showAlert(`
            <strong>Database Connection Issue</strong><br>
            Cannot connect to the API. Please check:<br>
            • Is your web server (Apache/Nginx) running?<br>
            • Is the api.php file in the correct location?<br>
            • Are your database credentials correct in config.php?<br>
            • Current API URL: ${API_BASE_URL}
        `, 'error');
        
        throw error;
    }
}

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected section
    document.getElementById(sectionId).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Load data based on section
    switch(sectionId) {
        case 'overview':
            loadOverview();
            break;
        case 'add-product':
            loadFormDropdowns();
            break;
        case 'view-products':
            loadProducts();
            break;
        case 'manage-farmers':
            loadFarmers();
            break;
        case 'manage-customers':
            loadCustomers();
            break;
        case 'view-orders':
            loadOrders();
            break;
    }
}

async function loadOverview() {
    try {
        const response = await apiCall('get_stats');
        if (response.success) {
            const stats = response.data;
            document.getElementById('total-products').textContent = stats.total_products || '0';
            document.getElementById('total-farmers').textContent = stats.total_farmers || '0';
            document.getElementById('total-customers').textContent = stats.total_customers || '0';
            document.getElementById('total-orders').textContent = stats.total_orders || '0';
        } else {
            // Fallback to hardcoded values if API fails
            document.getElementById('total-products').textContent = '24';
            document.getElementById('total-farmers').textContent = '6';
            document.getElementById('total-customers').textContent = '5';
            document.getElementById('total-orders').textContent = '5';
        }
    } catch (error) {
        console.error('Error loading overview:', error);
        showAlert('Failed to load dashboard statistics', 'error');
    }
}

async function loadFormDropdowns() {
    try {
        // Load categories and units for the add product form
        const [categoriesResponse, unitsResponse, farmersResponse] = await Promise.all([
            apiCall('get_categories'),
            apiCall('get_units'),
            apiCall('get_farmers')
        ]);
        
        if (categoriesResponse.success) {
            categories = categoriesResponse.data;
            updateCategoryDropdown();
        }
        
        if (unitsResponse.success) {
            units = unitsResponse.data;
            updateUnitsDropdown();
        }
        
        if (farmersResponse.success) {
            allFarmers = farmersResponse.data;
            updateFarmersDropdown();
        }
    } catch (error) {
        console.error('Error loading form dropdowns:', error);
    }
}

function updateCategoryDropdown() {
    const categorySelect = document.getElementById('category_id');
    if (categorySelect && categories.length > 0) {
        categorySelect.innerHTML = '<option value="">Choose a category...</option>';
        categories.forEach(category => {
            categorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
        });
    }
}

function updateUnitsDropdown() {
    const unitSelect = document.getElementById('unit_id');
    if (unitSelect && units.length > 0) {
        unitSelect.innerHTML = '<option value="">Choose a unit...</option>';
        units.forEach(unit => {
            unitSelect.innerHTML += `<option value="${unit.id}">${unit.name} (${unit.abbreviation})</option>`;
        });
    }
}

function updateFarmersDropdown() {
    const farmerSelect = document.getElementById('farmer_id');
    if (farmerSelect && allFarmers.length > 0) {
        farmerSelect.innerHTML = '<option value="">Choose a farmer...</option>';
        allFarmers.forEach(farmer => {
            farmerSelect.innerHTML += `<option value="${farmer.id}">${farmer.name} (${farmer.city})</option>`;
        });
    }
}

async function loadProducts() {
    const container = document.getElementById('products-container');
    
    // Show loading state
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading products...</p>
        </div>
    `;
    
    try {
        const response = await apiCall('get_products');
        
        if (response.success) {
            allProducts = response.data;
            
            if (allProducts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 50px;">No products found. Add some products to get started!</p>';
                return;
            }
            
            container.innerHTML = allProducts.map(product => `
                <div class="card">
                    <div class="card-title">${product.name}</div>
                    <div class="card-details">
                        <p><strong>বর্ণনা:</strong> ${product.description || 'No description available'}</p>
                        <p><strong>Farmer:</strong> ${product.farmer_name}</p>
                        <p><strong>Category:</strong> ${product.category_name}</p>
                        <p><strong>Available:</strong> ${product.quantity_available} ${product.unit_abbrev}</p>
                        <p><strong>Status:</strong> <span style="color: ${product.status === 'active' ? '#28a745' : '#ffc107'}">${product.status === 'active' ? 'In Stock' : 'Out of Stock'}</span></p>
                    </div>
                    <div class="card-price">৳${parseFloat(product.price).toFixed(2)} per ${product.unit_abbrev}</div>
                </div>
            `).join('');
        } else { 
            throw new Error(response.error || 'Failed to load products');
        }
    } catch (error) {
        console.error('Error loading products:', error);
        container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 50px;">Failed to load products. Please try again.</p>';
    }
}

async function loadFarmers() {
    const container = document.getElementById('farmers-container');
    
    // Show loading state
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading farmers...</p>
        </div>
    `;
    
    try {
        const response = await apiCall('get_farmers');
        
        if (response.success) {
            allFarmers = response.data;
            
            if (allFarmers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 50px;">No farmers registered yet. Register some farmers to get started!</p>';
                return;
            }
            
            container.innerHTML = allFarmers.map(farmer => {
                const joinDate = new Date(farmer.created_at).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short' 
                });
                
                return `
                    <div class="card">
                        <div class="card-title">👨‍🌾 ${farmer.name}</div>
                        <div class="card-details">
                            <p><strong>📧 Email:</strong> ${farmer.email || 'Not provided'}</p>
                            <p><strong>📱 Phone:</strong> ${farmer.phone || 'Not provided'}</p>
                            <p><strong>🏘️ Location:</strong> ${farmer.city || 'Not specified'}</p>
                            <p><strong>📍 Address:</strong> ${farmer.address || 'Not provided'}</p>
                            <p><strong>🌱 Products:</strong> ${farmer.product_count || 0} active products</p>
                            <p><strong>📅 Joined:</strong> ${joinDate}</p>
                        </div>
                        <div class="card-price">Active Farmer</div>
                    </div>
                `;
            }).join('');
            
            // Update farmer dropdown in add product form
            updateFarmersDropdown();
        } else {
            throw new Error(response.error || 'Failed to load farmers');
        }
    } catch (error) {
        console.error('Error loading farmers:', error);
        container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 50px;">Failed to load farmers. Please try again.</p>';
    }
}

async function loadCustomers() {
    const container = document.getElementById('customers-container');
    
    // Show loading state
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading customers...</p>
        </div>
    `;
    
    try {
        const response = await apiCall('get_customers');
        
        if (response.success) {
            allCustomers = response.data;
            
            if (allCustomers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 50px;">No customers registered yet. Add some customers to get started!</p>';
                return;
            }
            
            container.innerHTML = allCustomers.map(customer => {
                const getCustomerStatus = (orderCount, totalSpent) => {
                    if (totalSpent > 2000) return 'Premium Customer';
                    if (orderCount > 3) return 'Regular Customer';
                    return 'New Customer';
                };
                
                const status = getCustomerStatus(customer.order_count, customer.total_spent);
                const statusColor = status.includes('Premium') ? '#28a745' : status.includes('New') ? '#17a2b8' : '#6c757d';
                
                return `
                    <div class="card">
                        <div class="card-title">👤 ${customer.first_name} ${customer.last_name}</div>
                        <div class="card-details">
                            <p><strong>📧 Email:</strong> ${customer.email}</p>
                            <p><strong>📱 Phone:</strong> ${customer.phone || 'Not provided'}</p>
                            <p><strong>🏘️ City:</strong> ${customer.city || 'Not specified'}</p>
                            <p><strong>📍 Address:</strong> ${customer.address || 'Not provided'}</p>
                            <p><strong>📦 Orders:</strong> ${customer.order_count || 0} completed</p>
                            <p><strong>💰 Total Spent:</strong> ৳${parseFloat(customer.total_spent || 0).toFixed(2)}</p>
                        </div>
                        <div class="card-price" style="color: ${statusColor}">${status}</div>
                    </div>
                `;
            }).join('');
        } else {
            throw new Error(response.error || 'Failed to load customers');
        }
    } catch (error) {
        console.error('Error loading customers:', error);
        container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 50px;">Failed to load customers. Please try again.</p>';
    }
}

async function loadOrders() {
    const container = document.getElementById('orders-container');
    
    // Show loading state
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading orders...</p>
        </div>
    `;
    
    try {
        const response = await apiCall('get_orders');
        
        if (response.success) {
            allOrders = response.data;
            
            if (allOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 50px;">No orders found yet.</p>';
                return;
            }
            
            container.innerHTML = allOrders.map(order => {
                const orderDate = new Date(order.created_at).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short',
                    day: 'numeric'
                });
                
                // Format items list
                const itemsList = order.items.map(item => 
                    `${item.product_name} (${item.quantity}${item.unit})`
                ).join(', ');
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-number">📦 ${order.order_number}</div>
                            <div class="order-status status-${order.status}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</div>
                        </div>
                        <div class="customer-info">
                            <div class="info-item">
                                <div class="info-label">👤 Customer</div>
                                <div class="info-value">${order.customer_name}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">💰 Total Amount</div>
                                <div class="info-value">৳${parseFloat(order.total_amount).toFixed(2)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">📅 Order Date</div>
                                <div class="info-value">${orderDate}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">💳 Payment</div>
                                <div class="info-value" style="color: ${order.payment_status === 'paid' ? '#28a745' : '#ffc107'}">${order.payment_status.charAt(0).toUpperCase() + order.payment_status.slice(1)}</div>
                            </div>
                        </div>
                        <div class="card-details">
                            <p><strong>🛒 Items:</strong> ${itemsList}</p>
                            <p><strong>📍 Shipping:</strong> ${order.shipping_address}</p>
                            <p><strong>📱 Contact:</strong> ${order.customer_phone || 'Not provided'}</p>
                            ${order.notes ? `<p><strong>📝 Notes:</strong> ${order.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            throw new Error(response.error || 'Failed to load orders');
        }
    } catch (error) {
        console.error('Error loading orders:', error);
        container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 50px;">Failed to load orders. Please try again.</p>';
    }
}

async function loadAllData() {
    try {
        showAlert('Refreshing all data...', 'success');
        
        await Promise.all([
            loadOverview(),
            loadProducts(),
            loadFarmers(),
            loadCustomers(),
            loadOrders(),
            loadFormDropdowns()
        ]);
        
        showAlert('All data refreshed successfully!', 'success');
    } catch (error) {
        console.error('Error refreshing data:', error);
        showAlert('Some data failed to refresh. Please try again.', 'error');
    }
}

function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
    alertDiv.innerHTML = message;
    
    // Insert at the top of the active section
    const activeSection = document.querySelector('.section.active');
    if (activeSection) {
        activeSection.insertBefore(alertDiv, activeSection.firstChild);
        
        // Remove alert after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
}

// Form submission handlers
document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const productData = Object.fromEntries(formData);
    
    // Validate required fields
    if (!productData.farmer_id || !productData.category_id || !productData.unit_id || !productData.name || !productData.price || !productData.quantity_available) {
        showAlert('Please fill in all required fields.', 'error');
        return;
    }
    
    try {
        const response = await apiCall('add_product', 'POST', productData);
        
        if (response.success) {
            showAlert('🌱 Product added successfully! Ready for customers.', 'success');
            this.reset();
            // Reload products if we're on that section
            if (document.getElementById('view-products').classList.contains('active')) {
                loadProducts();
            }
            loadOverview(); // Update stats
        } else {
            showAlert(response.message || 'Failed to add product. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Error adding product:', error);
        showAlert('Error adding product. Please try again.', 'error');
    }
});

document.getElementById('farmerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const farmerData = Object.fromEntries(formData);
    
    // Validate required fields
    if (!farmerData.farmer_name) {
        showAlert('Farmer name is required.', 'error');
        return;
    }
    
    try {
        const response = await apiCall('add_farmer', 'POST', farmerData);
        
        if (response.success) {
            showAlert('👨‍🌾 Farmer registered successfully! Welcome to FreshVege family.', 'success');
            this.reset();
            loadFarmers();
            loadOverview(); // Update stats
            updateFarmersDropdown(); // Update dropdown in add product form
        } else {
            showAlert(response.message || 'Failed to register farmer. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Error registering farmer:', error);
        showAlert('Error registering farmer. Please try again.', 'error');
    }
});

document.getElementById('customerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const customerData = Object.fromEntries(formData);
    
    // Validate required fields
    if (!customerData.customer_first_name || !customerData.customer_last_name || !customerData.customer_email) {
        showAlert('First name, last name, and email are required.', 'error');
        return;
    }
    
    try {
        const response = await apiCall('add_customer', 'POST', customerData);
        
        if (response.success) {
            showAlert('👤 Customer added successfully! Account is ready.', 'success');
            this.reset();
            loadCustomers();
            loadOverview(); // Update stats
        } else {
            showAlert(response.message || 'Failed to add customer. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Error adding customer:', error);
        showAlert('Error adding customer. Please try again.', 'error');
    }
});

// Search and filter functions
document.getElementById('product-search')?.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const productCards = document.querySelectorAll('#products-container .card');
    
    productCards.forEach(card => {
        const productName = card.querySelector('.card-title').textContent.toLowerCase();
        const productDesc = card.querySelector('.card-details').textContent.toLowerCase();
        
        if (productName.includes(searchTerm) || productDesc.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
});

document.getElementById('order-search')?.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const orderCards = document.querySelectorAll('#orders-container .order-card');
    
    orderCards.forEach(card => {
        const orderText = card.textContent.toLowerCase();
        
        if (orderText.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
});

// Category filter for products
document.getElementById('product-category-filter')?.addEventListener('change', function() {
    const selectedCategory = this.value;
    const productCards = document.querySelectorAll('#products-container .card');
    
    productCards.forEach(card => {
        if (!selectedCategory) {
            card.style.display = 'block';
        } else {
            const categoryText = card.querySelector('.card-details').textContent;
            const product = allProducts.find(p => p.name === card.querySelector('.card-title').textContent);
            
            if (product && product.category_id == selectedCategory) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        }
    });
});

// Order status filter
document.getElementById('order-status-filter')?.addEventListener('change', function() {
    const selectedStatus = this.value;
    const orderCards = document.querySelectorAll('#orders-container .order-card');
    
    orderCards.forEach(card => {
        if (!selectedStatus) {
            card.style.display = 'block';
        } else {
            const statusElement = card.querySelector('.order-status');
            if (statusElement && statusElement.classList.contains(`status-${selectedStatus}`)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        }
    });
});

// Initialize dashboard
window.onload = async function() {
    try {
        // Show initial loading message
        showAlert('Initializing FreshVege Dashboard...', 'success');
        
        // Try to load data from API first
        try {
            await loadAllData();
            showAlert('Welcome to FreshVege Dashboard! সুস্বাগতম! Connected to database successfully.', 'success');
        } catch (error) {
            console.warn('Database connection failed, using demo data:', error);
            
            // Fall back to demo data if API fails
            loadDemoData();
            showAlert(`
                <strong>Demo Mode Active</strong><br>
                Could not connect to database. Showing demo data.<br>
                <small>To fix: Ensure api.php exists and your web server is running</small>
            `, 'error');
        }
    } catch (error) {
        console.error('Error initializing dashboard:', error);
        loadDemoData();
        showAlert('Dashboard loaded in demo mode. Database connection failed.', 'error');
    }
};

// Fallback demo data
function loadDemoData() {
    // Load hardcoded demo data as fallback
    document.getElementById('total-products').textContent = '24';
    document.getElementById('total-farmers').textContent = '6';
    document.getElementById('total-customers').textContent = '5';
    document.getElementById('total-orders').textContent = '5';
    
    // Demo products
    const demoProducts = [
        {
            name: 'Fresh Capsicum',
            description: 'রঙিন ক্যাপসিকাম, সালাদ ও রান্নার জন্য উপযুক্ত',
            price: '৳80.00',
            quantity_available: '25.50',
            farmer_name: 'Rahim Hasnat',
            category_name: 'Vegetables',
            unit_abbrev: 'kg',
            status: 'active'
        },
        {
            name: 'Fresh Tomatoes',
            description: 'টাটকা লাল টমেটো, রান্না ও সালাদের জন্য',
            price: '৳75.00',
            quantity_available: '30.00',
            farmer_name: 'Rahim Hasnat',
            category_name: 'Vegetables',
            unit_abbrev: 'kg',
            status: 'active'
        },
        // Add more demo data as needed
    ];
    
    // Display demo products
    const container = document.getElementById('products-container');
    if (container) {
        container.innerHTML = demoProducts.map(product => `
            <div class="card">
                <div class="card-title">${product.name}</div>
                <div class="card-details">
                    <p><strong>বর্ণনা:</strong> ${product.description}</p>
                    <p><strong>Farmer:</strong> ${product.farmer_name}</p>
                    <p><strong>Category:</strong> ${product.category_name}</p>
                    <p><strong>Available:</strong> ${product.quantity_available} ${product.unit_abbrev}</p>
                    <p><strong>Status:</strong> <span style="color: #28a745">In Stock</span></p>
                </div>
                <div class="card-price">${product.price} per ${product.unit_abbrev}</div>
            </div>
        `).join('');
    }
}

// Add some interactivity to stats cards
document.addEventListener('DOMContentLoaded', function() {
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach(card => {
        card.addEventListener('click', function() {
            const label = this.querySelector('.stat-label').textContent;
            
            // Remove active class from all nav buttons first
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (label.includes('Products')) {
                showSection('view-products');
                document.querySelector('[onclick="showSection(\'view-products\')"]').classList.add('active');
            } else if (label.includes('Farmers')) {
                showSection('manage-farmers');
                document.querySelector('[onclick="showSection(\'manage-farmers\')"]').classList.add('active');
            } else if (label.includes('Customers')) {
                showSection('manage-customers');
                document.querySelector('[onclick="showSection(\'manage-customers\')"]').classList.add('active');
            } else if (label.includes('Orders')) {
                showSection('view-orders');
                document.querySelector('[onclick="showSection(\'view-orders\')"]').classList.add('active');
            }
        });
    });
}); 
</script>
</body>
</html>